# MDシミュレーションのtips
MDシミュレーション関連で、役に立ちそうなことや注意すべき点をまとめます (教えてくださった先生、先輩方に感謝申し上げます)。

- [MDシミュレーションのtips](#mdシミュレーションのtips)
  - [シミュレーションエンジンの種類](#シミュレーションエンジンの種類)
  - [トラジェクトリの可視化](#トラジェクトリの可視化)
    - [溶媒の除去](#溶媒の除去)
    - [フレームの抜き出し](#フレームの抜き出し)
  - [研究室サーバ上のトラジェクトリを確認する方法](#研究室サーバ上のトラジェクトリを確認する方法)
    - [方法1: X11 Forwarding](#方法1-x11-forwarding)
    - [方法2: sshfsでファイルシステムをマウントする (おすすめ)](#方法2-sshfsでファイルシステムをマウントする-おすすめ)
    - [方法3: rsyncでファイルをコピー (大容量データにおすすめ)](#方法3-rsyncでファイルをコピー-大容量データにおすすめ)
    - [方法4: scpでファイルをコピー](#方法4-scpでファイルをコピー)
  - [MD実行時チェックリスト](#md実行時チェックリスト)
    - [毎回確認](#毎回確認)
    - [新しいシステム作成時に確認](#新しいシステム作成時に確認)
    - [実行中に確認](#実行中に確認)
    - [途中から再開するときに確認](#途中から再開するときに確認)


## シミュレーションエンジンの種類
- OpenMM (おすすめ)
- GENESIS
- LAMMPS

## トラジェクトリの可視化
代表的なツールとしては、以下のものが挙げられる。詳しくは、[tutorial_vizリポジトリ](https://github.com/matsunagalab/tutorial_viz)を参照。
- PyMOL
  - 画像がきれい＆操作が簡単
- vmd
  - 大容量データも軽々動く
- blender (+ MolecularNodes)
  - 論文の図を描くときに使う
- nglview (python)
  - notebookで可視化したいときに使う
- py3dmol (python)
  - notebookで可視化したいときに使う

大容量データだと可視化に時間がかかるので、mdconvert (mdtraj付属のコマンド)を用いて溶媒を除去したり、フレームを抜き出したりする。

### 溶媒の除去
1. タンパク質だけのPDBを作成 (元のPDBを編集してタンパク質部分だけ残す)
2. mdconvertの`-a`オプションを使って、dcdからタンパク質だけをとりだしたdcdを作る (そのために原子番号のインデックスファイルが必要。インデックスはゼロベース)
3. 原子番号のインデックスファイルは以下のようにして作れます。インデックスの上限の値は適当に変えること。
```
for i in $(seq 0 2635); do echo -n "${i} " >>./prot.index; done
```
4. mdconvertは以下の通り
```
mdconvert -a prot.index run.dcd -o run_prot.dcd
```

その他の使い方は、公式HP参考のこと。
- 参考: [mdconvert](https://mdtraj.org/1.9.4/mdconvert.html)

### フレームの抜き出し
例えば、10フレームごとに抜き出したい場合は以下の通り。
```
mdconvert run.dcd -o run_stride10.dcd -s 10
```

## 研究室サーバ上のトラジェクトリを確認する方法
### 方法1: X11 Forwarding
- 以下の記事を参考にX11 Forwardingの設定を行い、vmdで可視化する。
- 楽だが、画質がやや落ちるのと動作が重い
```
(Mac)$ ssh -XY crab
(crab)$ vmd /path/to/data
```
- 参考: [Qiita X11 ForwardingしてMacにGUI表示する](https://qiita.com/loftkun/items/37340745f211ea5d7ece)

### 方法2: sshfsでファイルシステムをマウントする (おすすめ)
- sshfsで、研究室サーバのファイルをローカルのディレクトリにマウントする
- ファイル転送に時間はかかるが、いちいちコピーしなくてよいので楽。
- Macに入っている好きな可視化ビューアを使うことができる。
```
(Mac)$ sshfs username@crab-remote:[見たいディレクトリパス(研究室サーバ)] [マウントするディレクトリパス(Mac)]
```

### 方法3: rsyncでファイルをコピー (大容量データにおすすめ)
- rsyncはファイルを同期するコマンド
- 一度rsyncしてしまえば、次からは差分を取ってくるだけで済むので大容量データに向いている
```
(Mac)$ rsync -auz -vv --stats --progress --exclude "*~" username@crab-remote:[コピー元ディレクトリパス(研究室サーバ)/] [コピー先ディレクトリパス(Mac)/]
```

### 方法4: scpでファイルをコピー
- scpはsshでファイルをコピーするコマンド
- 基本の使い方はcpコマンドと一緒
- 一度しか見ないようなデータは、rsyncではなくてこちらでもいいかも
```
(Mac)$ scp -rC username@crab-remote:[コピー元パス(研究室サーバ)] [コピー先パス(Mac)]
```

## MD実行時チェックリスト
### 毎回確認
- 流す予定のnodeは空いているか？
    - sinfoでnodeが生きているか確認
    - ssh [node]→htopでCPU/メモリ確認
    - ssh [node]→nvidia-smiでGPU/メモリ確認
- 流す予定のGPU番号は空いているか？
    - ssh [node]→nvidia-smiでGPU/メモリ確認
    - export CUDA_VISIBLE_DEVICES="[ID]” で指定した番号が正しいか確認

### 新しいシステム作成時に確認
- 塩濃度は正しいか？
    - mMとMを間違えていないか確認
    - そもそもイオン強度の計算方法が正しいか確認 https://en.wikipedia.org/wiki/Ionic_strength
- 温度は正しいか？
    - Kと℃を間違えていないか確認
- (周期境界条件の場合、)長さスケールでボックスサイズが分子サイズの2倍以上になっているか？
    - 小さすぎるとイメージング(隣接ボックス分子と干渉すること)を引き起こす
- 配列の範囲は正しいか？
    - 特にpythonなどで切り出した場合、0-indexはじまりなので要注意
- 使っている長さの単位は正しいか？
    - pythonライブラリによって、使用単位がnmとÅで異なる
- 初期構造が問題ないか目視で確認したか？
    - VMDやPyMOLで可視化する
    - 芳香環を別の分子が貫通していたり、構造が分断されていないか要check
- 自分のいるディレクトリは正しいか？
    - バックアップ用のディレクトリにいないか？
- 保存ファイル名は正しいか？

### 実行中に確認
- ログやトラジェクトリは更新されているか？
  - 進み具合が極端に遅すぎないか確認。時間の目安は先輩や先生に聞いてみる。
- ログで、ポテンシャルエネルギーが発散していないか？
- 可視化して、イメージングが起きていないか？
- 可視化して、現実にはありえない構造を取っていないか？
- ファイルサイズがディスク容量に対して大きすぎないか？

### 途中から再開するときに確認
- ログやトラジェクトリは上書きされないようにしたか？
- 再開用のファイル(.chkや.rst)は指定したか？　　　　　　　　
